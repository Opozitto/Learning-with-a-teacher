# Проект: "Обучение с учителем: качество модели"

# **Описание проекта**
Интернет-магазин «В один клик» продаёт разные товары: для детей, для дома, мелкую бытовую технику, косметику и даже продукты. Отчёт магазина за прошлый период показал, что активность покупателей начала снижаться. Привлекать новых клиентов уже не так эффективно: о магазине и так знает большая часть целевой аудитории. Возможный выход — удерживать активность постоянных клиентов. Сделать это можно с помощью персонализированных предложений.
«В один клик» — современная компания, поэтому её руководство не хочет принимать решения просто так — только на основе анализа данных и бизнес-моделирования.

Необходимо разработать решение, которое позволит персонализировать предложения постоянным клиентам, чтобы увеличить их покупательскую активность.

# **Задачу нужно выполнить в два этапа:**
- Разработать модель, которая предскажет вероятность снижения покупательской активности.
- Выделить сегмент покупателей, проанализируйть его и предложить, как увеличить его покупательскую активность. Использовать данные моделирования, данные о прибыли покупателей и исходные данные (если понадобятся).

# **Установленный подход к решению задачи:**
Руководство одобрило описание решения, нужно его реализовать.
- Нужно промаркировать уровень финансовой активности постоянных покупателей. В компании принято выделять два уровня активности: «снизилась», если клиент стал покупать меньше товаров, и «прежний уровень».
- Нужно собрать данные по клиентам по следующим группам:
  - Признаки, которые описывают коммуникацию сотрудников компании с клиентом.
  - Признаки, которые описывают продуктовое поведение покупателя. Например, какие товары покупает и как часто.
  - Признаки, которые описывают покупательское поведение клиента. Например, сколько тратил в магазине.
  - Признаки, которые описывают поведение покупателя на сайте. Например, как много страниц просматривает и сколько времени проводит на сайте.
- Нужно построить модель, которая предскажет вероятность снижения покупательской активности клиента в следующие три месяца.
- В исследование нужно включить дополнительные данные финансового департамента о прибыльности клиента: какой доход каждый покупатель приносил компании за последние три месяца.
- Используя данные модели и данные о прибыльности клиентов, нужно выделить сегменты покупателей и разработать для них персонализированные предложения.

# **Описание данных**
Данные для работы находятся в нескольких таблицах.  

**market_file.csv** Таблица, которая содержит данные о поведении покупателя на сайте, о коммуникациях с покупателем и его продуктовом поведении.
- id — номер покупателя в корпоративной базе данных.
- Покупательская активность — рассчитанный класс покупательской активности (целевой признак): «снизилась» или «прежний уровень».
- Тип сервиса — уровень сервиса, например «премиум» и «стандарт».
- Разрешить сообщать — информация о том, можно ли присылать покупателю дополнительные предложения о товаре. Согласие на это даёт покупатель.
- Маркет_актив6мес — среднемесячное значение маркетинговых коммуникаций компании, которое приходилось на покупателя за последние 6 месяцев. Это значение показывает, какое число рассылок, звонков, показов рекламы и прочего приходилось на клиента.
- Маркет_актив_тек_мес — количество маркетинговых коммуникаций в текущем месяце.
- Длительность — значение, которое показывает, сколько дней прошло с момента регистрации покупателя на сайте.
- Акционные_покупки — среднемесячная доля покупок по акции от общего числа покупок за последние 6 месяцев.
- Популярная_категория — самая популярная категория товаров у покупателя за последние 6 месяцев.
- Средний_просмотр_категорий_за_визит — показывает, сколько в среднем категорий покупатель просмотрел за визит в течение последнего месяца.
- Неоплаченные_продукты_штук_квартал — общее число неоплаченных товаров в корзине за последние 3 месяца.
- Ошибка_сервиса — число сбоев, которые коснулись покупателя во время посещения сайта.
- Страниц_за_визит — среднее количество страниц, которые просмотрел покупатель за один визит на сайт за последние 3 месяца.

**market_money.csv** Таблица с данными о выручке, которую получает магазин с покупателя, то есть сколько покупатель всего потратил за период взаимодействия с сайтом.
- id — номер покупателя в корпоративной базе данных.
- Период — название периода, во время которого зафиксирована выручка. Например, 'текущий_месяц' или 'предыдущий_месяц'.
- Выручка — сумма выручки за период.
  
**market_time.csv** Таблица с данными о времени (в минутах), которое покупатель провёл на сайте в течение периода.
- id — номер покупателя в корпоративной базе данных.
- Период — название периода, во время которого зафиксировано общее время.
- минут — значение времени, проведённого на сайте, в минутах.
  
**money.csv** Таблица с данными о среднемесячной прибыли покупателя за последние 3 месяца: какую прибыль получает магазин от продаж каждому покупателю.
- id — номер покупателя в корпоративной базе данных.
- Прибыль — значение прибыли.

# **Этапы выполнения работы и результаты.**
# Загрузка и предобработка данных

Загрузили данные и создали 4 датафрейма
- df_market_file
- df_market_money
- df_market_time
- df_money  
     
- Данные в таблицах соответствуют описанию
- Пропуски в данных отсутствуют 
- Дубликаты отсутствуют
- Необходимость корректировки типов данных отсутствует  

* Откорректировали названия столбцов и строковых значений
* Исправили некоторые значения

# Исследовательский анализ данных

По результатам проведенного анализа установлено следующее:  

- **Количественные признаки:**
  - `маркет_актив_6_мес` - среднемесячное значение маркетинговых коммуникаций за последние 6 месяцев.   
    Распределение от 0.9 до 6.6. Среднее 4.25.  
    Распределение отклоняется от нормального.  
    Отмечается некоторое количество (36 шт.) выбросов - клиенты, с которыми связывались в среднем менее 2 раз в месяц.  
  - `Маркет_актив_тек_мес` - количество маркетинговых коммуникаций в текущем месяце.  
    Принимает дискретные целочисленные значения:  3, 4 и 5.  
    Причем, примерно половина значений "4" - преобладающий класс. Что примерно соответствует среднему показателю маркетинговых коммуникаций за последние 6 месяцев.  
    Вместе с тем, клинеты с 1 - 2 контактами за текущий месяц отсутствуют.
  - `длительность` - дней прошло с момента регистрации покупателя на сайте.  
    Рачпределение от 110 до 1079. Среднее 602.
    Распределение отклоняется от нормального.
    При этом, для данного параметра эта тенденция говорит о том, что новых пользователей становится всё меньше.  
  - `акционные_покупки` - среднемесячная доля покупок по акции от общего числа покупок.  
    Отмечается две моды - в районе 0.24 и около 0.9.  
    Таким образом, можно выделить группу пользователей 165шт. (акционные_покупки > 0.8), которые почти все (или все) покупки совершают только по акциям.  
    При этом медианное значение (0.24) примерно отражает средний показатель пользователей, которые не стремятся совершать покупки только по акции.  
  - `средний_просмотр_категорий_за_визит` - сколько в среднем категорий покупатель просмотрел за визит.  
    Принимает дискретные целочисленные значения от 1 до 6 включительно.  
    При этом апроксимация распределения стремится к нормальному со средним 3. 
  - `неоплаченные_продукты_штук_квартал` - общее число неоплаченных товаров в корзине за последние 3 месяца.  
    Принимает дискретные целочисленные значения от 0 до 10 включительно.  
    При этом апроксимация распределения стремится к нормальному со средним 3, скошено слева.  
    Отмечается некоторое количество (34 шт.) выбросов (значения более 8).  
  - `ошибка_сервиса` - число сбоев, которые коснулись покупателя во время посещения сайта.  
    Принимает дискретные целочисленные значения от 0 до 9 включительно.  
    При этом апроксимация распределения стремится к нормальному со средним 4.  
  - `страниц_за_визит` - среднее количество страниц, которые просмотрел покупатель за один визит на сайт.  
    Принимает дискретные целочисленные значения от 1 до 20 включительно.  
    При этом апроксимация распределения стремится к нормальному со средним 8.  
  - `выручка` - сумма выручки за период.  
     Распределение близко к нормальному.  
     От 2758.7 до 7799.4. Среднее 5007.3. Стандартное отклонение 679.7.  
     Отмечается одно аномальное значение выброс (выручка 106862 руб.), существенно отличается от остальных (на порядок). А также всего 6 строк с выручкой = 0. 
     Вместе с тем, даже без учета экстремальных значений (0 и 106 тыс.) на box-plot отчетливо видны выбросы - значения, которые выходят за  границы усов boxplot (более чем на полтора межквартильных размаха) как слева, так и справа.
  - `минут` - значение времени, проведённого на сайте, в минутах.  
     Принимает целочисленные значения.  
     От 4 до 23. Среднее 13. Стандартное отклонение 4.  
     Апроксимация распределения близко к нормальному.  
  - `прибыль` - значение прибыли.  
    Распределение максимально приближено к нормальному.  
    От 0.86 до 7.43. Среднее 4.  Стандартное отклонение 1.01.
    Вместе с тем, на box-plot отчетливо видно некоторое количество выбросов - значений, которые выходят за  границы усов boxplot (более чем на полтора межквартильных размаха) как слева, так и справа.  
  
- **Категориальные признаки:**
  - `покупательская_активность` `df_market_file` - рассчитанный класс покупательской активности (целевой признак): «снизилась» или «прежний уровень». Биноминальный признак.   
    Отмечается, что покупательская активность снизилась у 38.3 % пользователей.  
  - `тип_сервиса` `df_market_file`- уровень сервиса: «премиум» или «стандарт». Биноминальный признак.  
    28.9 % пользователей пользуются премиум сервисом.  
  - `разрешить_сообщать` `df_market_file` - информация о том, можно ли присылать покупателю дополнительные предложения о товаре. Биноминальный признак.  
    74 % пользователей дали согласие на рассылку.  
  - `популярная_категория` `df_market_file` - самая популярная категория товаров у покупателя за последние 6 месяцев.  
    Признак содержит 6 классов. Распределение долей от 10.6 % (кухонная посуда) до 25.4 % (товары для детей).  
  - `период` `df_market_money` - название периода, во время которого зафиксирована выручка.   
    Значения распределены равномерно между тремя периодами. То есть по всем пользователям имеется информация за каждый из трех периодов (текущий, предыдущий, предпредыдущий месяцы).  
  - `период` `df_market_time` - название периода, во время которого зафиксировано общее время.  
    Значения распределены равномерно между двумя периодами. То есть по всем пользователям имеется информация за каждый из двух периодов (текущий, предыдущий месяцы).
  
**Отбрали клиентов с покупательской активностью не менее трёх месяцев.**
- Почти все (1297) пользователи из представленных данных - активные.  
    Отмечается, что только по 3 пользователям есть нулевые значения выручки.

# Корреляционный анализ  

Объединили в df_full таблицы market_file.csv, market_money.csv, market_time.csv. Создали отдельный столбец для каждого периода.

**Преобразовали признаки** 
- Признаки выручки:  
  Вместо трёх признаков (выручка_предпредыдущий_месяц, выручка_предыдущий_месяц, выручка_текущий_месяц) создали два:
    + `выручка_разница_тек`
    + `выручка_разница_прошл`
- Маркетинговая активность:  
  Создали признак маркет_актив_тек_6_мес, учитывающий данные текущего месяца:
    + `маркет_актив_тек_6_мес`

**Матрица Phik:**  
- Сильную связь покупательская активность имеет с  
  - количеством страниц за визит (0.75)  
  - количеством минут в предыдущем (0.69) и текущем (0.58) месяцах  
  
- Средняя связь таргета отмечается со следующими признаками:
  - маркет_актив_6_мес (0.54)
  - средний_просмотр_категорий_за_визит (0.54)
  - акционные_покупки (0.51)
  - неоплаченные_продукты_штук_квартал (0.51)
  
- Отсутсвие связи таргета со следующими признаками:
  - маркет_актив_тек_мес
  - разрешить_сообщать
  Значение 0 с таргетом означает, что между данными признаками и целевой переменной отсутствует любая линейная или нелинейная зависимость. Поэтому, признаки можно считать бесполезным для модели.
  
- Вероятное наличие мультиколлинеарности:
  - сильная связь выручки за текущий месяц с предыдущим (0.84). После преобразования данных - мультиколлинеарности отсутствует.
  
**VIF**  
- Полученные значения VIF говорят об отсутствии корреляции между признаками.  
  Отмечается умеренная корреляция выручка_предыдущий_месяц и выручка_текущий_месяц. Признаки имеют небольшую зависимость от других признаков. После преобразования данных - корреляция между признаками отсутствует.

# Обучение и оптимизация моделей

На этом этапе был реализован полный процесс предобработки данных, выбора признаков и обучения моделей с оптимизацией гиперпараметров. Основные шаги включают:  

1) Разделение данных на тренировочную и тестовую выборки.  
   Целевой признак — "покупательская активность".  
   Использовалась стратификация, чтобы сохранить пропорции классов в обеих выборках.  
   
2) Кодирование целевой переменной  
   - Класс "1" — снижение покупательской активности, "0" — сохранение прежнего уровня.
     Для кодирования использован LabelEncoder.  
     
3) Создание пайплайнов для обработки признаков.  
   - Категориальные признаки (OHE): Применение OneHotEncoding с предварительным заполнением пропусков.
   - Порядковые признаки (OrdinalEncoder): Кодирование с учетом заданного порядка категорий, включая этапы обработки пропусков до и после кодирования.
   - Числовые признаки: Масштабирование с использованием MinMaxScaler. Полиномиальные признаки второго порядка были исключены из-за ухудшения метрик.  
   
4) Выбор признаков.  
   Использован метод SelectKBest с функциями f_classif и mutual_info_classif для отбора наиболее значимых признаков.

5) Оптимизация гиперпараметров моделей.  
   Для оптимизации применялись OptunaSearchCV и GridSearchCV.  
   Метрики для подбора гиперпараметров:  
   - Основная: Recall (максимизация обнаружения клиентов с пониженной активностью).
   - Дополнительные: ROC-AUC, Precision, fbeta-score (с акцентом на Recall).  

6) Модели, участвующие в оптимизации. 
   - KNeighborsClassifier (KNN): Оптимизация количества соседей, веса и метрики расстояний.
   - DecisionTreeClassifier: Оптимизация глубины дерева, количества признаков и минимального числа объектов в узле.
   - LogisticRegression: Настройка параметров регуляризации, штрафов и максимального числа итераций.
   - SVC: Оптимизация параметров ядра, коэффициента регуляризации и класса весов.  

7) Результаты подбора гиперпараметров.  
   Оптимизировано все 4е модели при помощи OptunaSearchCV и дополнительно 2 модели (svc, knn) при помощи GridSearchCV.  
   Сравнение результатов каждой модели проведено по нескольким метрикам.   
   
8) Кросс-валидация и итоговая оценка.  
   Проведена кросс-валидация с использованием пайплайна для каждой модели.  
   Оценены средние значения метрик (Recall, Precision, fbeta-score, ROC-AUC) на обучающей выборке.   

**Вывод**  
Модель - SVC с параметрами от OptunaSearch при кросс-валидации показывает на тренировочной выборке recall = 1.0. То есть находит 100% клиентов с риском снижения активности. При этом, precision указанной модели сильно снизился (до 0.38), то есть дает очень много ложноположительных ответов.

Хороший результат recall (0.819488) показала модель knn с параметрами от GridSearchCV при сбалансированном precision (0.878791) и хорошим roc_auc (0.892944).  

Таким образом, лучше остановиться на модели knn GridSearchCV.    

Параметры модели knn:  
'models__n_neighbors': 67,  
'models__weights': 'distance',  
'models__metric': 'euclidean',   
'selector__score_func': <function f_classif at 0x7fa6764023a0>,  
'selector__k': 5

Модель на тестовой выборке показала хороший recall (0.8293) и ROC-AUC (0.8950) при высоком precision (0.8870).

# Анализ важности признаков  

**Выводы по результатам анализа важности признаков**

- Наиболее значимые признаки:

   - **Количество страниц за визит** (страниц_за_визит) — имеет наибольшее среднее абсолютное значение SHAP (0.130). Это указывает на то, что данный признак играет ключевую роль в прогнозировании активности покупателей. Логично предположить, что чем больше страниц просматривает клиент, тем выше вероятность его вовлеченности.
   - **Доля акционных покупок** (акционные_покупки) — значимость 0.130. Этот показатель указывает на интерес клиента к промо-акциям и выгодным предложениям. Вместе с тем, клиенты, совершающие больше акционных покупок, более склонны к снижению активности, что может говорить о временной заинтересованности в акциях.  
   - **Количество минут за предыдущий месяц** (0.12) и **за текущий месяц** (0.11). Он отражает уровень взаимодействия клиента с платформой за недавний и текущий период и также сильно влияет на предсказание.
   - **Маркетинговая активность за 6 месяцев** (маркет_актив_6_мес) — SHAP (0.06). Это указывает на умеренную зависимость между уровнем маркетинговой активности и покупательским поведением. Клиенты, на которых была направлена активная маркетинговая поддержка, менее склонны к снижению активности.
  

- Признаки с низкой значимостью:
   - в результате отбора признаков с помощью SelectKBest остальные признаки не попали в модель ввиду низкой значимости:   
     - 'выручка_разница_тек',    
     - 'тип_сервиса',    
     - 'неоплаченные_продукты_штук_квартал',     
     - 'длительность',     
     - 'средний_просмотр_категорий_за_визит',    
     - 'маркет_актив_тек_мес',    
     - 'выручка_разница_прошл',    
     - 'разрешить_сообщать_нет',     
     - 'ошибка_сервиса',    
     - все признаки раздела 'популярная_категория'.  

   
**Практические выводы:**

   - Основное внимание при разработке стратегии привлечения клиентов следует уделить анализу активности на сайте (количество страниц за визит и времени, проведенного на сайте). Увеличение времени, проведённого клиентами на сайте, и числа просматриваемых страниц является важным фактором, снижающим вероятность снижения активности.
   - Доля акционных покупок — значимый показатель. Регулярные акции и персонализированная коммуникация помогают удерживать клиентов. Однако важно учитывать, что акционные покупки могут быть временным стимулом, а не долговременной стратегией. Поэтому необходимо разработать более долгосрочные стратегии лояльности, например, программы накопления бонусов.  
   - Ранняя идентификация риска - на основании данных о количестве минут и просмотренных страниц можно заранее выявлять снижение интереса клиентов и запускать стратегии удержания, например, персонализированные предложения.  
   - Низкая значимость остальных признаков предполагает, что они имеют ограниченное влияние на покупательскую активность и могут использоваться как дополнительные данные для сегментации, но не для основного анализа.  

**Рекомендации:** 
- Для дальнейшего улучшения модели стоит сосредоточиться на более глубоких данных о поведении клиентов на сайте и изучении временной динамики активности.  
- Для группы клиентов, склонных к снижению активности, эффективными будут таргетированные акции и улучшение UX-процессов (например, оплаты). Это позволит удерживать их интерес и снизить вероятность потери вовлечённости.  

# Анализ сегмента клиентов с топ-20% прибыльности  

Анализ сегмента клиентов с топ-20% по прибыльности и высокой вероятностью снижения покупательской активности (>50%) выявил их ключевую важность для бизнеса. Потеря активности этого сегмента может существенно повлиять на финансовые показатели компании, поскольку они приносят значительную долю выручки.

1. Основные характеристики сегмента  

   Объем сегмента:  
- Всего в выборке — 262 клиента с топ-20% прибыли.
- Из них 99 клиентов (37%) имеют высокий риск снижения активности (вероятность ≥50%).
- 34% топ-клиентов имеют вероятность снижения активности более 95%, что требует немедленных действий.  

   Средняя прибыльность:  
- Средняя прибыль на клиента в сегменте — 5.37, что значительно выше, чем у остальных клиентов (3.65).
- Суммарная прибыль сегмента составляет 5181.02 единицы, или 26.96% от общей прибыли.
- Доля прибыли клиентов с высоким риском (≥50%) снижения активности — 10.04% от общей прибыли.  

2. Особенности покупательского поведения  
   - Длительная маркетинговая активность более значима для прибыльных клиентов, чем активность в текущем месяце. Следует сделать акцент на поддержании вовлеченности этих клиентов в течение длительного времени.  
   - Прибыльные клиенты проводят больше времени на сайте, но просматривают меньше категорий и страниц. Это указывает на необходимость оптимизации навигации и персонализации рекомендаций.  
   - Прибыльные клиенты менее склонны к акционным предложениям, что открывает возможность увеличения маржи на таких сегментах.  
   
   Риск снижения активности и тип сервиса:
- Клиенты с подпиской премиум преобладают среди тех, кто имеет высокий риск снижения активности:
- Это указывает на необходимость особого внимания к премиум-клиентам.  

   Стабильность выручки:  
- Средняя выручка топ-клиентов стабильно ниже, чем у менее прибыльных клиентов.
- Это может свидетельствовать о том, что их прибыльность обеспечивается высокомаржинальными товарами, а не частотой покупок.
- Клиенты в топовом сегменте демонстрируют меньшую разницу в выручке между периодами, что подтверждает стабильность их покупательской активности. Рекомендуется внедрить программы лояльности, чтобы сохранить эту стабильность.  

3. Взаимосвязи и значимые признаки  

   Анализ корреляций (метрика phik) показал, что вероятность снижения активности наиболее сильно связана со следующими факторами:  
- доля акционных покупок (0.46) — клиенты, зависящие от акций, менее устойчивы.
- количество страниц за визит (0.39) — чем меньше страниц просматривает клиент, тем выше риск.
- минут за текущий месяц (0.36) — снижение активности проявляется в уменьшении вовлечённости.
- минут за предыдущий месяц (0.35) — снижение активности проявляется в уменьшении вовлечённости.
- маркетинговые свзи за текущий месяц (0.35) — снижение контактов ухудшает удержание.
- средний просмотр категорий за визит (0.32) — снижение активности проявляется в уменьшении вовлечённости.  

4. Общие тенденции  

- Маркетинговая активность и покупательское поведение топ-клиентов в целом схожи с остальными клиентами, но премиум-клиенты показывают более высокий риск снижения активности.
- Высокоприбыльные клиенты остаются важными за счёт стабильной активности и покупки высокомаржинальных товаров, однако требуют дополнительных мер для удержания.  

# **Рекомендации**

1) Сфокусироваться на премиум-клиентах:  
   - Разработать стратегию удержания, включающую эксклюзивные предложения, персонализированные рекомендации и премиальные привилегии, 
   - Увеличить маркетинговую активность, направленную на этот сегмент, особенно в части индивидуальных коммуникаций.  

2) Повысить вовлечённость клиентов с высоким риском:  
   - Увеличить время, проводимое клиентами на сайте, за счёт улучшения интерфейса, персонализированных рекомендаций и удобных фильтров.
   - Стимулировать просмотр большего количества категорий товаров через таргетированные рекламные кампании.  

3) Улучшить качество сервиса и процессов оплаты:  
   - Минимизировать количество неоплаченных продуктов, упрощая процесс оформления заказов.
   - Проконтролировать и снизить ошибки сервиса.  
   
4) Использовать акционные предложения с осторожностью:  
   - Предлагать акции, но избегать зависимости премиум-клиентов от скидок.
   - Важно сохранить восприятие премиального качества.
